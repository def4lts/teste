{"ast":null,"code":"import axios from \"axios\";\nimport { parseCookies, setCookie } from \"nookies\";\nimport { signOut } from \"../contexts/AuthContext\";\nvar cookies = parseCookies();\nvar isRefreshing = false;\nvar failedRequestQueue = [];\nexport var api = axios.create({\n  baseURL: \"http://54.94.41.183:3333\",\n  headers: {\n    Authorization: \"Bearer \".concat(cookies[\"0dayTokenFront.token\"])\n  }\n});\napi.interceptors.response.use(function (response) {\n  return response;\n}, function (error) {\n  if (error.response.status === 401) {\n    var _error$response$data;\n\n    if (((_error$response$data = error.response.data) === null || _error$response$data === void 0 ? void 0 : _error$response$data.code) === \"token.expired\") {\n      cookies = parseCookies();\n      var _cookies = cookies,\n          refreshToken = _cookies[\"0dayTokenFront.cookies\"];\n      var originalConfig = error.config;\n\n      if (!isRefreshing) {\n        isRefreshing = true;\n        api.post(\"/refresh-token\", {\n          token: refreshToken\n        }).then(function (response) {\n          var token = response.data.token;\n          setCookie(undefined, \"0dayTokenFront.token\", token, {\n            maxAge: 60 * 60 * 24 * 30,\n            //30 days\n            path: \"/\"\n          });\n          setCookie(undefined, \"0dayTokenFront.refreshToken\", response.data.refreshToken, {\n            maxAge: 60 * 60 * 24 * 30,\n            //30 days\n            path: \"/\"\n          });\n          api.defaults.headers[\"Authorization\"] = \"Bearer \".concat(token);\n          failedRequestQueue.forEach(function (request) {\n            return request.onSuccess(token);\n          });\n          failedRequestQueue = [];\n        })[\"catch\"](function (err) {\n          failedRequestQueue.forEach(function (request) {\n            return request.onFailure(err);\n          });\n          failedRequestQueue = [];\n        })[\"finally\"](function () {\n          isRefreshing = false;\n        });\n      }\n\n      return new Promise(function (resolve, reject) {\n        failedRequestQueue.push({\n          onSuccess: function onSuccess(token) {\n            originalConfig.headers[\"Authorization\"] = \"Bearer \".concat(token);\n            resolve(api(originalConfig));\n          },\n          onFailure: function onFailure(err) {\n            reject(err);\n          }\n        });\n      });\n    } else {\n      signOut();\n    }\n  }\n\n  return Promise.reject();\n});","map":{"version":3,"sources":["/home/smoke/Ãrea de Trabalho/dashgo/src/services/api.ts"],"names":["axios","parseCookies","setCookie","signOut","cookies","isRefreshing","failedRequestQueue","api","create","baseURL","headers","Authorization","interceptors","response","use","error","status","data","code","refreshToken","originalConfig","config","post","token","then","undefined","maxAge","path","defaults","forEach","request","onSuccess","err","onFailure","Promise","resolve","reject","push"],"mappings":"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","sourcesContent":["import axios, { AxiosError } from \"axios\";\nimport { destroyCookie, parseCookies, setCookie } from \"nookies\";\nimport { signOut } from \"../contexts/AuthContext\";\n\nlet cookies = parseCookies();\nlet isRefreshing = false;\nlet failedRequestQueue = [];\n\nexport const api = axios.create({\n  baseURL: \"http://54.94.41.183:3333\",\n  headers: {\n    Authorization: `Bearer ${cookies[\"0dayTokenFront.token\"]}`,\n  },\n});\n\napi.interceptors.response.use(\n  (response) => {\n    return response;\n  },\n  (error: AxiosError) => {\n    if (error.response.status === 401) {\n      if (error.response.data?.code === \"token.expired\") {\n        cookies = parseCookies();\n\n        const { \"0dayTokenFront.cookies\": refreshToken } = cookies;\n        const originalConfig = error.config;\n\n        if (!isRefreshing) {\n          isRefreshing = true;\n\n          api\n            .post(\"/refresh-token\", {\n              token: refreshToken,\n            })\n            .then((response) => {\n              const { token } = response.data;\n\n              setCookie(undefined, \"0dayTokenFront.token\", token, {\n                maxAge: 60 * 60 * 24 * 30, //30 days\n                path: \"/\",\n              });\n\n              setCookie(\n                undefined,\n                \"0dayTokenFront.refreshToken\",\n                response.data.refreshToken,\n                {\n                  maxAge: 60 * 60 * 24 * 30, //30 days\n                  path: \"/\",\n                }\n              );\n\n              api.defaults.headers[\"Authorization\"] = `Bearer ${token}`;\n\n              failedRequestQueue.forEach((request) => request.onSuccess(token));\n              failedRequestQueue = [];\n            })\n            .catch((err) => {\n              failedRequestQueue.forEach((request) => request.onFailure(err));\n              failedRequestQueue = [];\n            })\n            .finally(() => {\n              isRefreshing = false;\n            });\n        }\n\n        return new Promise((resolve, reject) => {\n          failedRequestQueue.push({\n            onSuccess: (token: string) => {\n              originalConfig.headers[\"Authorization\"] = `Bearer ${token}`;\n\n              resolve(api(originalConfig));\n            },\n            onFailure: (err: AxiosError) => {\n              reject(err);\n            },\n          });\n        });\n      } else {\n        signOut();\n      }\n    }\n\n    return Promise.reject();\n  }\n);\n"]},"metadata":{},"sourceType":"module"}